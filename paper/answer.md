#! https://zhuanlan.zhihu.com/p/356458540

# Fast Visibility Restoration from a Single Color or Gray Level Image 
## 导言
本文所使用的测试图片集为CVPR O-HAZY NTIRE 2018测试数据集。
比较早的论文了，偶然间看到，挺感兴趣，花了一晚的时间做了复现，现在来分享一下，我自己写的python复现和谷歌上找到的MATLAB复现(未测试）都已放到我的github仓库中：

https://github.com/Owen718/fast-visibility-restoration-from-a-single-color-or-gray-level-image

试了下，效果还是不错的，速度很赞。代码没怎么优化，优化以后达到实时效果是完全可行的。
论文里的最后一步，Dedicated Tone Mapping，还没填坑，改天有空再做，先来看看目前的效果：



## 解读
首先是经典的成像：
$$
L(x, y)=L_{0}(x, y) e^{-k d(x, y)}+L_{s}\left(1-e^{-k d(x, y)}\right)   (1)
$$

给没接触过的朋友简单说下，其中，$L(x，y)$是像素$(x，y)$处的表观亮度，$d(x，y)$是具有固有亮度$L_0(x，y)$的相应物体的距离，$L_s$是天空的亮度，$k$表示大气的消光系数。我们知道，**何凯明博士的DCP方法关注的是transmission map的估计，即$t=e^{-k d(x, y)}$,求出暗通道和背景光值，代入公式求解$t$。这篇论文的方法则很不同，关注的是$V=L_{s}(1-e^{-k d(x, y)})$,也就是上式的后半部分，这部分怎么理解呢？其实就是大气面纱，也就是理解为一个雾的"遮罩"。** 来看下公式的推导：
设：
    $$V(x,y)=L_{s}(1-e^{-k d(x, y)})$$
则式(1)可重写为(为了和论文里保持一致，$I_s$即$L_s$)：
    $$ I(x, y)=R(x, y)\left(1-\frac{V(x, y)}{I_{s}}\right)+V(x, y) $$

那么，只要估计出$I_s$和$V(x,y)$，就可以用下式复原去雾图像：
$$
R(x, y)=\frac{I(x, y)-V(x, y)}{1-\frac{V(x, y)}{I_{s}}}
$$

论文中,**使用了白平衡方法对图像进行了预处理**，这样使得雾的部分变得纯白，因此，$I_s$的值被固定为：

$$I_s=\{1,1,1\}$$

因此，只要估计出$V(x,y)$，就可以使用复原公式来复原去雾图像了。

### V(x,y) 估计
论文中，作者对$V(x,y)$提出了两个基于推导的约束:
* 1.$V(x,y)$大于等于0，且为单色图，对于每一个点，其值不能高于原图中RGB分量的最小值。该条件的物理意义是所有的像素点肯定都会受到大气光的影响。
* 2.设$
W(x, y)=\min (I(x, y))
$，即$W$为原图RGB三通道的最小值。求$W$这一步我直接复用了DCP的暗通道求解代码，基本一致。那么可得：$V(x, y) \leq W(x, y)$。这个条件可以从公式中看出，其物理意义是这样的图像中的每个像素点的亮度值是包含两部分的，除了大气光之外还有景物本身反射的光，所以V(x,y)肯定是小于或者等于像素值在所有通道最小值的。

也就是说：

$$
0 \leq V(x, y) \leq W(x, y)
$$

**由于在近似的景深部分，V(x,y)的值是近似相等的，所以对粗略得到的W(x,y)应该进行平滑，但是在景深变化较大的部分V(x,y)的值是会出现剧烈变化的，所以要尽量保留边缘。一般的边缘滤波器如高斯滤波只能平滑，而双边滤波器（A Bilateral Filter）可以很好的保留边缘的同时消除噪声。双边滤波器能做到这些原因在于它不像普通的高斯/卷积低通滤波，只考虑了位置对中心像素的影响，它还考虑了卷积核中像素与中心像素之间相似程度的影响，根据位置影响与像素值之间的相似程度生成两个不同的权重表(WeightTable)，在计算中心像素的时候加以考虑这两个权重，从而实现双边低通滤波。**

因此：
* 1.中值滤波器是特殊的双边滤波器，作者采用中值滤波器对W(x,y)进行滤波：
   $$A(x, y)=\operatorname{median}_{s_{v}}(W)(x, y) $$
*  2.同时由于滤波之后的图像中仍然会存在一些纹理，而这些纹理肯定是不属于雾的,所以
$$B(x, y)=A(x, y)-\operatorname{median}_{s_{v}}(|W-A|)(x, y)$$
这样就可以消除纹理，确定留下来的都是属于雾的成分

* 3.由于B(x,y)是我们细化之后的Atmospheric Veil，所以仍然要遵守Atmospheric Veil的两个约束条件：
  $$ V(x, y)=\max (\min (p B(x, y), W(x, y)), 0) $$
  
  公式中的sv是中值滤波器的尺寸大小，p是考虑天空光比例的大小一般的取值是在0.9~0.95之间。现实中，空气中总会不可避免地包含一些杂质分子．如果彻底地移除雾的存在，图像会看起来不真实，并且深度感会丢失．所以可以通过引进1个常数p，有针对性地保留一部分覆盖遥远景物的雾。

求得的$V(x,y)$:

### 复原
代入公式复原即可：
$$ R(x, y)=\frac{I(x, y)-V(x, y)}{1-\frac{V(x, y)}{I_{s}}} $$

### Smoothing Adapted to Contrast Magnification
代码中我用$ksize=(5,5)$的平滑滤波代替。大家可以自己补充一下试试。
### Dedicated Tone Mapping
改天有空继续填坑。


## END
**最后，欢迎fork/star本人的项目仓库~求图像处理岗位远程实习。。**
再放一些图给大家看看：

